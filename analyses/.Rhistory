grid.arrange(ilemuc, betall, ncol=1, nrow=2)
ilemuc<-ggplot(ile, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 140:150, y = 18, label = "ILEMUC")
betall<-ggplot(bet, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 140:150, y = 18, label = "BETALL")
grid.arrange(ilemuc, betall, ncol=1, nrow=2)
ilemuc<-ggplot(ile, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 140, y = 18, label = "ILEMUC")
betall<-ggplot(bet, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 140, y = 18, label = "BETALL")
grid.arrange(ilemuc, betall, ncol=1, nrow=2)
ilemuc<-ggplot(ile, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 140, y = 18, label = "Ilex mucronata")
betall<-ggplot(bet, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 140, y = 18, label = "Betula alleghaniensis")
grid.arrange(ilemuc, betall, ncol=1, nrow=2)
ilemuc<-ggplot(ile, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 140, y = 18, label = "Ilex mucronata")
betall<-ggplot(bet, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 135, y = 18, label = "Betula alleghaniensis")
grid.arrange(ilemuc, betall, ncol=1, nrow=2)
ilemuc<-ggplot(ile, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 140, y = 18, label = "Ilex mucronata")
betall<-ggplot(bet, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 137, y = 18, label = "Betula alleghaniensis")
grid.arrange(ilemuc, betall, ncol=1, nrow=2)
ilemuc<-ggplot(ile, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 140, y = 18, label = "Ilex mucronata")
betall<-ggplot(bet, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 140, y = 18, label = "Betula alleghaniensis")
grid.arrange(ilemuc, betall, ncol=1, nrow=2)
rm(list=ls()) # remove everything currently held in the R memory
options(stringsAsFactors=FALSE)
graphics.off()
# Load libraries
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(ncdf4)
library(Interpol.T)
library(chillR)
library(raster)
library(maptools)
library(rgeos)
library(rgdal)
raster1<-brick("~/Desktop/tn_0.25deg_reg_v16.0.nc", varname="tn", sep="")
eur.temp<-nc_open("~/Desktop/tn_0.25deg_reg_v16.0.nc")
raster1<-brick("//WeldShare/Wolkovich Lab/Budburst Review - Ospree/Climate Data/tn_0.25deg_reg_v15.0.nc", varname="tn", sep="")
eur.temp <- nc_open("//128.103.155.31/WeldShare/Wolkovich Lab/Budburst Review - Ospree/Climate Data/tn_0.25deg_reg_v15.0.nc")
plot(raster1[[45]])
#raster1 <- setMinMax(raster1)
#length(doy)/365
doy<-ncvar_get(eur.temp, "time")
doy<-as.Date(doy, origin="1950-01-01")
day<-substr(doy, 9,10)
year<-as.numeric(substr(doy, 1, 4))
month<-as.numeric(substr(doy, 6, 7))
timevec<-paste(year, month, day, sep="-")
years.vec<-as.character(timevec, format="Y-%m-%d")
year<-as.numeric(substr(years.vec, 1, 4))
#doy.vec<-as.POSIXlt(names(raster1), format="X%j")
dates<-as.Date(years.vec)
names(raster1)<-dates
empty.raster<-raster1[[1]]
values(empty.raster)<-NA
years<-1950:2016
leaps <- function(x) {
m <- c()
for(i in 1:50) {
year.i <- years[which(((years %% 4 == 0) & (years %% 100 !=0) | (years %% 400 == 0)))]
m <- c(m, year.i)
}
return(m)
}
leap.years<-as.data.frame(leaps(1))
leap.years<-leap.years[!duplicated(leaps(1)),]
#year<-1950:2016
empty.raster<-raster1[[1]]
num.false.spring.year<-list()
#dates.false.spring<-list()
for(i in 1951:1983){#i=1952
print(i)
year.i<-i
is.leap<-ifelse(year.i%in%leap.years,TRUE,FALSE)
sequence.years<-which(year==year.i)
#length(sequence.years)
raster.sub<-subset(raster1,sequence.years)
#numnonas<-sum(!is.na(values(raster.sub[[1]])))
rast.array<-array(75,dim=c(ncell(raster.sub),181))
if(is.leap){
for(j in 75:181){ ## you need to change
print(paste(year.i,j))
rast.array[,j]<-values(raster.sub[[j]])
}
}
if(!is.leap){
for(j in 75:181){ ## you need to change
print(paste(year.i,j))
rast.array[,j]<-values(raster.sub[[j]])
}
}
#dates.fs<-apply(rast.array, 1, function(x){ifelse(x<=-2.2, x, 0)})
num.false.spring<-apply(rast.array,1,function(x){sum(ifelse(x<=-2.2,1,0))})
non.nas.ids<-which(!is.na(num.false.spring))
#values(emp.rast)<-NA
values(empty.raster)<- NA
#non.nas.dates<-which(!is.na(dates.fs))
#plot(raster1[[1]])
values(empty.raster)[non.nas.ids]<- num.false.spring[!is.na(num.false.spring)]
#values(empty.raster)[non.nas.dates]<- dates.fs[!is.na(dates.fs)]
#plot(empty.raster)
#dates.false.spring[[i]]<- empty.raster
num.false.spring.year[[i]]<-empty.raster
}
length(num.false.spring.year)
final.raster.preCC<-stack(unlist(num.false.spring.year))
summed.false.springs.preCC<-calc(final.raster.preCC,sum)
fs.years.pre<-calc(final.raster.preCC, function(x) {sum(ifelse(x>=1,1,0))})
writeRaster(fs.years.pre,"~/Documents/git/regionalrisk/analyses/output/fs.30.pre", bylayer=TRUE,format="GTiff")
install.packages("gdal")
library(gdal)
library(rgdal)
install.packages("gdalUtils")
library("gdalUtils", lib.loc="/Library/Frameworks/R.framework/Versions/3.2/Resources/library")
install.packages("rgeos", repos="http://R-Forge.R-project.org", type="source")
install.packages("rgeos", repos = "http://R-Forge.R-project.org", type = "source")
library(rgeos)
install.packages("rgdal", repos="http://R-Forge.R-project.org", type="source")
install.packages("rgdal", type="source")
library(rgdal)
install.packages('rgdal',repos="http://www.stats.ox.ac.uk/pub/RWin")
rgdal::writeRaster(fs.years.post,"~/Documents/git/regionalrisk/analyses/output/fs.postCC", bylayer=TRUE,format="GTiff")
install.packages("rgeos", type="source")
install.packages("rgeos", type = "source")
install.packages("rgeos", repos="http://R-Forge.R-project.org", type="source")
install.packages(c('rgdal','rgeos'),repos="http://www.stats.ox.ac.uk/pub/RWin")
library("rgeos", lib.loc="/Library/Frameworks/R.framework/Versions/3.2/Resources/library")
detach("package:rgeos", unload=TRUE)
install.packages("rgdal")
install.packages("installr")
updateR()
install.packages("updateR")
version
if(!require(installr)) {
install.packages("installr");
require(installr)
}
library(installr)
version
load("/Users/CatherineChamberlain/Desktop/Moransel.RData")
rm(bcoord, bcoords, bprep, distgab, listw, nb, nbgab, test, xymat)
mem.select<-as.data.frame(moransel$MEM.select)
View(mem.select)
save.image("~/Downloads/MEM_forNacho.RData")
head(bb)
unique(bb$fs.count)
rm(moransel, MEM_model, MEM.moransel)
unique(y)
bb$check<-ave(bb$fs, bb$PEP_ID, bb$species, FUN=sum)
head(bb)
sort(unique(bb$check))
length(unique(bb$year))
sort(unique(y))
bb$check2<-ave(bb$fs, bb$PEP_ID, FUN=sum)
head(bb)
bb$fs.num<-ave(bb$fs, bb$PEP_ID, bb$species, bb$year, FUN=sum)
unique(bb$fs.num)
df<-bb
df$fs.num<-ave(df$fs, df$sp)
df$fs.sd<-ave(df$fs, df$sp, FUN=sd)
df$sp<-ifelse(df$sp==1, "A.hippocastanum", df$sp)
df$sp<-ifelse(df$sp==2, "A.glutinosa", df$sp)
df$sp<-ifelse(df$sp==3, "B.pendula", df$sp)
df$sp<-ifelse(df$sp==4, "F.sylvatica", df$sp)
df$sp<-ifelse(df$sp==5, "F.excelsior", df$sp)
df$sp<-ifelse(df$sp==6, "Q.robar", df$sp)
dx<-df%>%dplyr::select(-fs, -mat, -lat, -long)
dx<-dx[!duplicated(dx),]
library(dplyr)
dx<-df%>%dplyr::select(-fs, -mat, -lat, -long)
dx<-dx[!duplicated(dx),]
df$fs.lat<-ave(df$fs, df$latr)
#pre<-bb%>%filter(year>1950)%>%filter(year<=1983)
pre<-bb
pre$fs<-ave(pre$fs, pre$PEP_ID, pre$species, FUN=sum)
pre$sp<-as.numeric(as.factor(pre$species))
pre$mat<-ave(pre$mat, pre$PEP_ID)
pre$lat<-as.numeric(pre$lat)
pre$long<-as.numeric(pre$long)
pre<-pre%>%dplyr::select(lat.long, lat, long, mat, sp, fs)
pre.bx<-pre[!duplicated(pre),]
## subsetting data, preparing genus variable, removing NAs
pre.mat.prepdata <- subset(pre.bx, select=c("fs", "mat", "sp", "lat", "long"))
pre.mat.stan <- pre.mat.prepdata[complete.cases(pre.mat.prepdata),]
df$latr<-round(df$lat, digits=2)
######### Plotting time! ##########
df<-pre.mat.stan
df$fs.num<-ave(df$fs, df$sp)
df$fs.sd<-ave(df$fs, df$sp, FUN=sd)
df$sp<-ifelse(df$sp==1, "A.hippocastanum", df$sp)
df$sp<-ifelse(df$sp==2, "A.glutinosa", df$sp)
df$sp<-ifelse(df$sp==3, "B.pendula", df$sp)
df$sp<-ifelse(df$sp==4, "F.sylvatica", df$sp)
df$sp<-ifelse(df$sp==5, "F.excelsior", df$sp)
df$sp<-ifelse(df$sp==6, "Q.robar", df$sp)
dx<-df%>%dplyr::select(-fs, -mat, -lat, -long)
dx<-dx[!duplicated(dx),]
diff<-ggplot(dx, aes(x=as.factor(sp), y=fs.num)) + geom_point(col=sp) +
geom_linerange(aes(ymin=fs.num-fs.sd, ymax=fs.num+fs.sd), alpha=0.3) +
ylab(expression("Years with False Springs")) +
theme(panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.title.x=element_blank(),
axis.text.x = element_text(face = "italic", angle=45, vjust=0.5), axis.text=element_text(size=10))
#install.packages("rstan", repos = "https://cloud.r-project.org/", dependencies=TRUE)
library(ggplot2)
diff<-ggplot(dx, aes(x=as.factor(sp), y=fs.num)) + geom_point(col=sp) +
geom_linerange(aes(ymin=fs.num-fs.sd, ymax=fs.num+fs.sd), alpha=0.3) +
ylab(expression("Years with False Springs")) +
theme(panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.title.x=element_blank(),
axis.text.x = element_text(face = "italic", angle=45, vjust=0.5), axis.text=element_text(size=10))
diff<-ggplot(dx, aes(x=as.factor(sp), y=fs.num)) + geom_point(col=dx$sp) +
geom_linerange(aes(ymin=fs.num-fs.sd, ymax=fs.num+fs.sd), alpha=0.3) +
ylab(expression("Years with False Springs")) +
theme(panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.title.x=element_blank(),
axis.text.x = element_text(face = "italic", angle=45, vjust=0.5), axis.text=element_text(size=10))
plot(diff)
df$latr<-round(df$lat, digits=2)
df$fs.lat<-ave(df$fs, df$latr)
dl<-df%>%dplyr::select(fs.lat, latr, sp )
dl<-dl[!duplicated(dl),]
dl$latr<-as.numeric(dl$latr)
lat.spp<-ggplot(dl, aes(latr, fs.lat)) + xlab("Latitude") + geom_point(col=sp)
lat.spp<-ggplot(dl, aes(latr, fs.lat)) + xlab("Latitude") + geom_point(col=as.factor(sp))
lat.spp<-ggplot(dl, aes(latr, fs.lat)) + xlab("Latitude") + geom_point(col=as.factor(sp)) +
ylab("Number of False Springs")  + geom_smooth(aes(col=as.factor(sp)),method="lm", se=FALSE) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"),
legend.key=element_blank())
lat.spp<-ggplot(dl, aes(latr, fs.lat)) + xlab("Latitude") + geom_point(aes(col=as.factor(sp))) +
ylab("Number of False Springs")  + geom_smooth(aes(col=as.factor(sp)),method="lm", se=FALSE) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"),
legend.key=element_blank())
plot(lat.spp)
df$fs.mat<-ave(df$fs, df$mat)
dm<-df%>%dplyr::select(fs.mat, mat, sp )
dm<-dm[!duplicated(dm),]
dm$matr<-as.numeric(dm$matr)
mat.spp<-ggplot(dm, aes(mat, fs.mat)) + xlab("Mean Annual Temperature") + geom_point(aes(col=as.factor(sp))) +
ylab("Number of False Springs")  + geom_smooth(aes(col=as.factor(sp)),method="lm", se=FALSE) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"),
legend.key=element_blank())
plot(mat.spp)
rm(list=ls()) # remove everything currently held in the R memory
options(stringsAsFactors=FALSE)
graphics.off()
# Load libraries
library(dplyr)
library(tidyr)
library(ggplot2)
library(extrafont)
## Let's make the data...
d<- data.frame(study=c("Sorbus aucuparia - 50% (Lenz et al., 2016)", "Prunus avium - 50% (Lenz et al., 2016)", "Tilia platyphyllos - 50% (Lenz et al., 2016)",
"Acer pseudoplatanus - 50% (Lenz et al., 2016)", "Fagus sylvatica - 50% (Lenz et al., 2016)", "All species - hard freeze (Schwartz, 1993))",
"All species - soft freeze (Augspurger, 2013)", "Eucalyptus pauciflora (Barker et al., 2005)", "All species (Peterson & Abatzoglou, 2014)",
"All species (Cannell & Smith, 1986)", "Vaccinium spp. (Longstroth, 2012)", "Rosaceae - 10% (Longstroth, 2013)", "Rosaceae - 90% (Longstroth, 2013)",
"Wheat - 10 to 90% (Barlow et al., 2015)", "Wheat - 100% (Barlow et al., 2015)", "Rice - 100% (Sanchez et al., 2013)", "Corn - 100% (Sanchez et al., 2013)", "Wheat - 100% (Sanchez et al., 2013)"),
phase=c("Vegetative", "Vegetative", "Vegetative", "Vegetative", "Vegetative", "Both", "Both", "Both", "Both", "Both",
"Floral", "Vegetative", "Vegetative", "Floral", "Vegetative", "Vegetative", "Vegetative", "Vegetative"),
sector=c("Ecologicial", "Ecologicial", "Ecologicial", "Ecologicial", "Ecologicial", "Ecologicial",
"Ecologicial", "Ecologicial", "Ecologicial", "Agronomic", "Agronomic", "Agronomic", "Agronomic",
"Agronomic", "Agronomic", "Agronomic", "Agronomic", "Agronomic"),
temperature=c(-7.4, -8.5, -7.4, -6.7, -4.8, -2.2, -1.7, -5.8, -2.2, 2, -2.2, -7.2, -13.3, -4.5,
-5.5, 4.7, -1.8, -17.2),
sd=c(4, 5, 3, 4, 3, 0, 0, 0, 0, 1, 2.2, 0, 0, 0.5, 1.5, 1.3, 1.9, 1.2))
d$alph<-ifelse(d$sector=="Agronomic", 1, 2)
d$dataset<-reorder(d$study, d$alph)
d$dataset <- factor(d$dataset, levels = d$dataset[order(d$sector, d$temperature)])
my.xlab = expression(paste("Temperature Threshold ", degree,"C"))
temp<-ggplot(d, aes(x=dataset, y=temperature)) +
geom_linerange(aes(ymin=temperature-sd, ymax=temperature+sd, color=sector), alpha=0.3) +
geom_point(aes(shape=phase, color=sector)) + ylab(my.xlab) + theme(axis.title.y=element_blank()) +
geom_hline(yintercept=0, linetype=2) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(),
axis.line = element_line(colour = "black")) +
ylim(c(-20, 10))
temp<- temp + scale_x_discrete(labels=c("All species - soft freeze (Augspurger, 2013)"="All species - soft freeze (Augspurger, 2013)",
"All species (Peterson & Abatzoglou, 2014)"="All species (Peterson & Abatzoglou, 2014)",
"All species - hard freeze (Schwartz, 1993))"="All species - hard freeze (Schwartz, 1993))",
"Fagus sylvatica - 50% (Lenz et al., 2016)" = expression(paste(italic("Fagus sylvatica"),  "- 50% (Lenz et al., 2016)")),
"Eucalyptus pauciflora (Barker et al., 2005)"=expression(paste(italic("Eucalyptus pauciflora"), "(Barker et al., 2005)")),
"Acer pseudoplatanus - 50% (Lenz et al., 2016)"=expression(paste(italic("Acer pseudoplatanus"), "- 50% (Lenz et al., 2016)")),
"Tilia platyphyllos - 50% (Lenz et al., 2016)"=expression(paste(italic("Tilia platyphyllos"), "- 50% (Lenz et al., 2016)")),
"Sorbus aucuparia - 50% (Lenz et al., 2016"=expression(paste(italic("Sorbus aucuparia"), "- 50% (Lenz et al., 2016")),
"Prunus avium - 50% (Lenz et al., 2016)"=expression(paste(italic("Prunus avium"), "- 50% (Lenz et al., 2016)")),
"Rice - 100% (Sanchez et al., 2013)"="Rice - 100% (Sanchez et al., 2013)",
"All species (Cannell & Smith, 1986)"="All species (Cannell & Smith, 1986)",
"Corn - 100% (Sanchez et al., 2013)"="Corn - 100% (Sanchez et al., 2013)",
"Vaccinium spp. (Longstroth, 2012)"=expression(paste(italic("Vaccinium spp."), "(Longstroth, 2012)")),
"Wheat - 10 to 90% (Barlow et al., 2015)"="Wheat - 10 to 90% (Barlow et al., 2015)",
"Wheat - 100% (Barlow et al., 2015)"="Wheat - 100% (Barlow et al., 2015)",
"Rosaceae - 10% (Longstroth, 2013)"=expression(paste(italic("Rosaceae"), "- 10% (Longstroth, 2013)")),
"Rosaceae - 90% (Longstroth, 2013)"=expression(paste(italic("Rosaceae"), "- 90% (Longstroth, 2013)")),
"Wheat - 100% (Sanchez et al., 2013)"="Wheat - 100% (Sanchez et al., 2013)"))
temp +coord_flip()
temp +coord_flip()
temp<- temp + scale_x_discrete(labels=c("All species - soft freeze (Augspurger, 2013)"="All species - soft freeze (Augspurger, 2013)",
"All species (Peterson & Abatzoglou, 2014)"="All species (Peterson & Abatzoglou, 2014)",
"All species - hard freeze (Schwartz, 1993))"="All species - hard freeze (Schwartz, 1993))",
"Fagus sylvatica - 50% (Lenz et al., 2016)" = expression(paste(italic("Fagus sylvatica"),  "- 50% (Lenz et al., 2016)")),
"Eucalyptus pauciflora (Barker et al., 2005)"=expression(paste(italic("Eucalyptus pauciflora"), "(Barker et al., 2005)")),
"Acer pseudoplatanus - 50% (Lenz et al., 2016)"=expression(paste(italic("Acer pseudoplatanus"), "- 50% (Lenz et al., 2016)")),
"Tilia platyphyllos - 50% (Lenz et al., 2016)"=expression(paste(italic("Tilia platyphyllos"), "- 50% (Lenz et al., 2016)")),
"Sorbus aucuparia - 50% (Lenz et al., 2016"=expression(paste(italic("Sorbus aucuparia"), "- 50% (Lenz et al., 2016")),
"Prunus avium - 50% (Lenz et al., 2016)"=expression(paste(italic("Prunus avium"), "- 50% (Lenz et al., 2016)")),
"Rice - 100% (Sanchez et al., 2013)"="Rice - 100% (Sanchez et al., 2013)",
"All species (Cannell & Smith, 1986)"="All species (Cannell & Smith, 1986)",
"Corn - 100% (Sanchez et al., 2013)"="Corn - 100% (Sanchez et al., 2013)",
"Vaccinium spp. (Longstroth, 2012)"=expression(paste(italic("Vaccinium spp."), "(Longstroth, 2012)")),
"Wheat - 10 to 90% (Barlow et al., 2015)"="Wheat - 10 to 90% (Barlow et al., 2015)",
"Wheat - 100% (Barlow et al., 2015)"="Wheat - 100% (Barlow et al., 2015)",
"Rosaceae - 10% (Longstroth, 2013)"=expression(paste(italic("Rosaceae"), "- 10% (Longstroth, 2013)")),
"Rosaceae - 90% (Longstroth, 2013)"=expression(paste(italic("Rosaceae"), "- 90% (Longstroth, 2013)")),
"Wheat - 100% (Sanchez et al., 2013)"="Wheat - 100% (Sanchez et al., 2013)"))
temp<- temp + scale_x_discrete(labels=c("All species - soft freeze (Augspurger, 2013)"="All species - soft freeze (Augspurger, 2013)",
"All species (Peterson & Abatzoglou, 2014)"="All species (Peterson & Abatzoglou, 2014)",
"All species - hard freeze (Schwartz, 1993))"="All species - hard freeze (Schwartz, 1993))",
"Fagus sylvatica - 50% (Lenz et al., 2016)" = expression(paste(italic("Fagus sylvatica"),  "- 50% (Lenz et al., 2016)")),
"Eucalyptus pauciflora (Barker et al., 2005)"=expression(paste(italic("Eucalyptus pauciflora"), "(Barker et al., 2005)")),
"Acer pseudoplatanus - 50% (Lenz et al., 2016)"=expression(paste(italic("Acer pseudoplatanus"), "- 50% (Lenz et al., 2016)")),
"Tilia platyphyllos - 50% (Lenz et al., 2016)"=expression(paste(italic("Tilia platyphyllos"), "- 50% (Lenz et al., 2016)")),
"Sorbus aucuparia - 50% (Lenz et al., 2016"=expression(paste(italic("Sorbus aucuparia"), "- 50% (Lenz et al., 2016")),
"Prunus avium - 50% (Lenz et al., 2016)"=expression(paste(italic("Prunus avium"), "- 50% (Lenz et al., 2016)")),
"Rice - 100% (Sanchez et al., 2013)"="Rice - 100% (Sanchez et al., 2013)",
"All species (Cannell & Smith, 1986)"="All species (Cannell & Smith, 1986)",
"Corn - 100% (Sanchez et al., 2013)"="Corn - 100% (Sanchez et al., 2013)",
"Vaccinium spp. (Longstroth, 2012)"=expression(paste(italic("Vaccinium spp."), "(Longstroth, 2012)")),
"Wheat - 10 to 90% (Barlow et al., 2015)"="Wheat - 10 to 90% (Barlow et al., 2015)",
"Wheat - 100% (Barlow et al., 2015)"="Wheat - 100% (Barlow et al., 2015)",
"Rosaceae - 10% (Longstroth, 2013)"=expression(paste(italic("Rosaceae"), "- 10% (Longstroth, 2013)")),
"Rosaceae - 90% (Longstroth, 2013)"=expression(paste(italic("Rosaceae"), "- 90% (Longstroth, 2013)")),
"Wheat - 100% (Sanchez et al., 2013)"="Wheat - 100% (Sanchez et al., 2013)"))
temp<-ggplot(d, aes(x=dataset, y=temperature)) +
geom_linerange(aes(ymin=temperature-sd, ymax=temperature+sd, color=sector), alpha=0.3) +
geom_point(aes(shape=phase, color=sector)) + ylab(my.xlab) + theme(axis.title.y=element_blank()) +
geom_hline(yintercept=0, linetype=2) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(),
axis.line = element_line(colour = "black")) +
ylim(c(-20, 10))
temp<- temp + scale_x_discrete(labels=c("All species - soft freeze (Augspurger, 2013)"="All species - soft freeze (Augspurger, 2013)",
"All species (Peterson & Abatzoglou, 2014)"="All species (Peterson & Abatzoglou, 2014)",
"All species - hard freeze (Schwartz, 1993))"="All species - hard freeze (Schwartz, 1993))",
"Fagus sylvatica - 50% (Lenz et al., 2016)" = expression(paste(italic("Fagus sylvatica"),  "- 50% (Lenz et al., 2016)")),
"Eucalyptus pauciflora (Barker et al., 2005)"=expression(paste(italic("Eucalyptus pauciflora"), "(Barker et al., 2005)")),
"Acer pseudoplatanus - 50% (Lenz et al., 2016)"=expression(paste(italic("Acer pseudoplatanus"), "- 50% (Lenz et al., 2016)")),
"Tilia platyphyllos - 50% (Lenz et al., 2016)"=expression(paste(italic("Tilia platyphyllos"), "- 50% (Lenz et al., 2016)")),
"Sorbus aucuparia - 50% (Lenz et al., 2016"=expression(paste(italic("Sorbus aucuparia"), "- 50% (Lenz et al., 2016")),
"Prunus avium - 50% (Lenz et al., 2016)"=expression(paste(italic("Prunus avium"), "- 50% (Lenz et al., 2016)")),
"Rice - 100% (Sanchez et al., 2013)"="Rice - 100% (Sanchez et al., 2013)",
"All species (Cannell & Smith, 1986)"="All species (Cannell & Smith, 1986)",
"Corn - 100% (Sanchez et al., 2013)"="Corn - 100% (Sanchez et al., 2013)",
"Vaccinium spp. (Longstroth, 2012)"=expression(paste(italic("Vaccinium spp."), "(Longstroth, 2012)")),
"Wheat - 10 to 90% (Barlow et al., 2015)"="Wheat - 10 to 90% (Barlow et al., 2015)",
"Wheat - 100% (Barlow et al., 2015)"="Wheat - 100% (Barlow et al., 2015)",
"Rosaceae - 10% (Longstroth, 2013)"=expression(paste(italic("Rosaceae"), "- 10% (Longstroth, 2013)")),
"Rosaceae - 90% (Longstroth, 2013)"=expression(paste(italic("Rosaceae"), "- 90% (Longstroth, 2013)")),
"Wheat - 100% (Sanchez et al., 2013)"="Wheat - 100% (Sanchez et al., 2013)"))
temp +coord_flip()
## Take 2: February 2017! ##
## Take 3: July 2017! ## Nacho's clean code to run stan models on Ospree
############################################
## housekeeping
rm(list=ls())
options(stringsAsFactors = FALSE)
library(rstan)
library(ggplot2)
library(shinystan)
library(bayesplot)
library(rstanarm)
library(brms)
library(ggstance)
setwd("~/Documents/git/ospree/analyses")
# make sure this is the correct file (we're still cleaning as I write this!)
bb <- read.csv("output/ospree_clean_withchill_BB.csv", header=TRUE)
taxon <- read.csv("output/bb_analysis/taxon/complex_levels.csv", header=TRUE)
respvars.thatwewant <- c("daystobudburst", "percentbudburst")
bb.resp <- bb[which(bb$respvar.simple %in% respvars.thatwewant),]
bb.resp <- subset(bb.resp, respvar != "thermaltime") # doesn't remove anything
## make a bunch of things numeric (eek!)
bb.resp$forceday <- as.numeric(bb.resp$forcetemp)
bb.resp$forcenight <- as.numeric(bb.resp$forcetemp_night)
bb.resp$photonight <- as.numeric(bb.resp$photoperiod_night)
bb.resp$photo <- as.numeric(bb.resp$photoperiod_day)
bb.resp$force <- bb.resp$forceday
bb.resp$force[is.na(bb.resp$forcenight)==FALSE & is.na(bb.resp$photo)==FALSE &
is.na(bb.resp$photonight)==FALSE] <-
(bb.resp$forceday[is.na(bb.resp$forcenight)==FALSE & is.na(bb.resp$photo)==FALSE &
is.na(bb.resp$photonight)==FALSE]*
bb.resp$photo[is.na(bb.resp$forcenight)==FALSE & is.na(bb.resp$photo)==FALSE &
is.na(bb.resp$photonight)==FALSE] +
bb.resp$forcenight[is.na(bb.resp$forcenight)==FALSE & is.na(bb.resp$photo)==FALSE &
is.na(bb.resp$photonight)==FALSE]*
bb.resp$photonight[is.na(bb.resp$forcenight)==FALSE & is.na(bb.resp$photo)==FALSE &
is.na(bb.resp$photonight)==FALSE])/24
bb.resp$chill <- as.numeric(bb.resp$Total_Utah_Model) # before 12 March 2018: Total_Chilling_Hours, Total_Chill_portions
bb.resp$resp <- as.numeric(bb.resp$response.time)
# merge in labgroup (we could do this elsewhere someday)
bb.wlab <- merge(bb.resp, taxon, by=c("genus","species"), all.x=TRUE)
tt <- table(bb.wlab$complex)
bb.wlab <- subset(bb.wlab, complex %in% names(tt[tt > 100])) ### testing
# [1] "Betula_complex"        "Betula_pendula"        "Betula_pubescens"      "Fagus_sylvatica"
# [5] "Malus_domestica"       "Picea_abies"           "Picea_glauca"          "Pseudotsuga_menziesii"
# [9] "Ribes_nigrum"          "Ulmus_complex"
myspp<-c("Betula_complex", "Betula_pendula", "Betula_pubescens", "Fagus_sylvatica", "Picea_abies", "Picea_glauca","Pseudotsuga_menziesii", "Ulmus_complex")
bb.wlab<-dplyr::filter(bb.wlab, complex%in%myspp)
columnstokeep <- c("datasetID", "genus", "species", "varetc", "woody", "forcetemp",
"photoperiod_day", "response", "response.time", "Total_Chill_portions",
"complex", "provenance.lat")
bb.wlab.sm <- subset(bb.wlab, select=columnstokeep)
## make a bunch of things numeric (eek!)
bb.wlab.sm$force <- as.numeric(bb.wlab.sm$forcetemp)
bb.wlab.sm$photo <- as.numeric(bb.wlab.sm$photoperiod_day)
bb.wlab.sm$chill <- as.numeric(bb.wlab.sm$Total_Chill_portions)
bb.wlab.sm$resp <- as.numeric(bb.wlab.sm$response.time)
bb.wlab.sm$lat<-as.numeric(bb.wlab.sm$provenance.lat)
## subsetting data, preparing genus variable, removing NAs
ospr.prepdata <- subset(bb.wlab.sm, select=c("resp", "chill", "photo", "force", "complex", "lat"))
dim(subset(bb.wlab.sm, is.na(chill)==FALSE & is.na(photo)==FALSE & is.na(force)==FALSE
& is.na(lat)==FALSE))
ospr.stan <- ospr.prepdata[complete.cases(ospr.prepdata),]
ospr.stan$sp <- as.numeric(as.factor(ospr.stan$complex))
## Center?
#ospr.stan$cchill<-ospr.stan$chill/24
#ospr.stan$cforce<- scale(ospr.stan$force, center=TRUE)
#ospr.stan$cchill<- scale(ospr.stan$cchill, center=TRUE)
#ospr.stan$cphoto<- scale(ospr.stan$photo, center=TRUE)
#ospr.stan$clat<- scale(ospr.stan$lat, center=TRUE)
ospr.stan$presp<-ospr.stan$resp+1
ospr.stan$presp<-as.integer(round(ospr.stan$presp, digits=0))
ospr.stan<-ospr.stan[which(ospr.stan$presp!=1000),]
lat.brm.uncent<-brm(presp~ force + photo + chill + lat + force:photo + force:chill + photo:chill + force:lat + photo:lat +
chill:lat + (1|sp) + (force-1|sp) + (photo-1|sp)
+ (chill-1|sp) + (lat-1|sp) + (photo:lat-1|sp) +
(force:photo-1|sp) + (force:chill-1|sp) + (force:lat-1|sp) +
(photo:chill-1|sp) + (chill:lat-1|sp), data=ospr.stan, family=poisson, chains=2)
## Center?
#ospr.stan$cchill<-ospr.stan$chill/24
#ospr.stan$cforce<- scale(ospr.stan$force, center=TRUE)
#ospr.stan$cchill<- scale(ospr.stan$cchill, center=TRUE)
#ospr.stan$cphoto<- scale(ospr.stan$photo, center=TRUE)
#ospr.stan$clat<- scale(ospr.stan$lat, center=TRUE)
ospr.stan$chill<-ospr.stan$chill+1
lat.brm.uncent<-brm(presp~ force + photo + chill + lat + force:photo + force:chill + photo:chill + force:lat + photo:lat +
chill:lat + (1|sp) + (force-1|sp) + (photo-1|sp)
+ (chill-1|sp) + (lat-1|sp) + (photo:lat-1|sp) +
(force:photo-1|sp) + (force:chill-1|sp) + (force:lat-1|sp) +
(photo:chill-1|sp) + (chill:lat-1|sp), data=ospr.stan, family=poisson, chains=2)
lat.stan<-stan_glmer(presp~ force + photo + chill + lat + force:photo + force:chill + photo:chill + force:lat + photo:lat +
chill:lat + (1|sp), data=ospr.stan, family=poisson, chains=2)
pp_checks(lat.stan)
pp_check(lat.stan)
lat.stan
lat.brm.uncent<-brm(presp~ force + photo + chill + lat + force:photo + force:chill + photo:chill + force:lat + photo:lat +
chill:lat + (1|sp), data=ospr.stan, family=poisson, chains=2)
lat.brm.uncent<-brm(presp~ force + photo + chill + lat + force:photo + force:chill + photo:chill + force:lat + photo:lat +
chill:lat + (1|sp) + (force-1|sp) + (photo-1|sp)
+ (chill-1|sp) + (lat-1|sp) + (photo:lat-1|sp) +
(force:photo-1|sp) + (force:chill-1|sp) + (force:lat-1|sp) +
(photo:chill-1|sp) + (chill:lat-1|sp), data=ospr.stan, family=poisson(), chains=2)
ospr.stan <- ospr.prepdata[complete.cases(ospr.prepdata),]
ospr.stan$sp <- as.numeric(as.factor(ospr.stan$complex))
## Center?
#ospr.stan$cchill<-ospr.stan$chill/24
ospr.stan$cforce<- scale(ospr.stan$force, center=TRUE)
ospr.stan$cchill<- scale(ospr.stan$chill, center=TRUE)
ospr.stan$cphoto<- scale(ospr.stan$photo, center=TRUE)
ospr.stan$clat<- scale(ospr.stan$lat, center=TRUE)
#ospr.stan$chill<-ospr.stan$chill+1
ospr.stan$presp<-ospr.stan$resp+1
ospr.stan$presp<-as.integer(round(ospr.stan$presp, digits=0))
lat.brm<-brm(presp~ cforce + cphoto + cchill + clat + cforce:cphoto + cforce:cchill + cphoto:cchill + cforce:clat + cphoto:clat +
cchill:clat + (1|sp) + (cforce-1|sp) + (cphoto-1|sp)
+ (cchill-1|sp) + (clat-1|sp) + (cphoto:clat-1|sp) +
(cforce:cphoto-1|sp) + (cforce:cchill-1|sp) + (cforce:clat-1|sp) +
(cphoto:cchill-1|sp) + (cchill:clat-1|sp), data=ospr.stan, family=poisson, chains=2)
